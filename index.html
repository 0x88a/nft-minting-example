<!DOCTYPE html>
<html lang="en">
<head>
		<title> NFT Generation </title>
		<script src="js/jquery.js"></script>
		<script src="js/web3.min.js"></script>
		<script src="abi.js"></script>
		<script src="https://unpkg.com/konva@8/konva.min.js"></script>
		<style>
			.header {
				margin-bottom: 12px;
			}
			
		</style>
</head>

<body>
	<div class="header">
		<b> NFT Generation Example </b> <br>
		<i> This website is a demonstration of automatic NFT Generation. <br>
		It aims to be able to create NFTs randomly, asign meta data and retrieve NFT info such as owner, rarity & traits through either a unique hash or meta tags </i>
	</div>
	<div class="body">
		<div class="form" style="width: 900px">
			<div style="width: 40%">
				<input id="address_nft" placeholder="Address" style="width: 100%" readonly disabled /> <br>
				<button id="init_nft" style="width: 102%"> Initialise Wallet </button> <br>
				<button id="mint_nft" style="width: 102%"> Mint </button>
			</div>
			<br>
			<div style="width: 50%">
				<input id="input_nft" placeholder="Image Hash" style="width: 60%" />
				<button id="generate_nft" style="width: 18%"> Generate </button>
			</div>
		</div>
		
		<div id="log"></div>
		<div id="image_nft" style="margin-top: 12px;"></div>
	</div>
</body>
</html>

<script>
	<!-- load our web3 stuff -->
	function random_number(lower, upper) {
		return Math.floor(Math.random() * (upper - lower) + lower);
	}
	
	var eyes = ["Angry.png", "Cute.png", "Cyborg.png", "Dollar Sign.png", "Fire.png","Heart.png", "HODL.png", "Laser.png", "Sleeping.png"];
	var hat = ["Army Hat.png", "Btc.png", "Bucket.png", "Cap.png", "Chef Hat.png", "Eth.png", "Halo.png", "HODL.png", "Top hat.png"]
	
    async function f() {
        web3 = new Web3(Web3.givenProvider); // Whatever provider they have injected
		// When you deploy your contract, update this address.
		var result=await web3.eth.requestAccounts().catch();
        var acts=await web3.eth.getAccounts().catch();
		
		$("#address_nft").val(result[0]);

		function mint(hash, uri) {
			var contractAddress = "0xCA9B2C3B584FC92cE20F0BB260124dF3Ad25Fc43";
			contract = new web3.eth.Contract(contractABI, contractAddress);
			// the transaction has been sent
			<!-- return contract.methods.mint(hash, 1, uri) -->
			<!-- .send({ from: userAccount }) -->
			<!-- .on("receipt", function(receipt) { -->
			  <!-- $("#log").text("Successfully created!"); -->
			<!-- }) -->
			<!-- .on("error", function(error) { -->
			  <!-- // Do something to alert the user their transaction has failed -->
			  <!-- $("#log").text(error); -->
			<!-- }); -->
		}
	
	}			
				
		$("#generate_nft").click(function() {
				var eyesOff = random_number(0, 8);
				var hatOff = random_number(0, 8);
				var hash = eyesOff.toString() + hatOff.toString();
			
				var layer = new Konva.Layer();
			
				var stage = new Konva.Stage({
					container: 'image_nft',
					width: 256,
					height: 256,
				});
				
				
				Konva.Image.fromURL('./img/Base.png', function (base) {
					base.setAttrs({
						x: 0,
						y: 0,
						scaleX: 0.1,
						scaleY: 0.1,
				});
					layer.add(base);
				});
				
				Konva.Image.fromURL('./img/' + eyes[eyesOff], function (eyes) {
					eyes.setAttrs({
						x: 0,
						y: 0,
						scaleX: 0.1,
						scaleY: 0.1,
				});
					layer.add(eyes);
				});
				
				offset = random_number(0, 12);
				Konva.Image.fromURL('./img/' + hat[hatOff], function (hat) {
					hat.setAttrs({
						x: 0,
						y: 0,
						scaleX: 0.1,
						scaleY: 0.1,
				});
					layer.add(hat);
				});		
				
				stage.add(layer);
		
	
			$("#mint_nft").click(function() {
					var canvas = layer.getCanvas()._canvas;
					var canvasData = canvas.toDataURL("image/png");
						
					$.ajax({
						url: "store.php",
						type: 'POST',
						data: {
							imgBase64: canvasData,
							hash: hash
						},
						dataType: 'json',
						success: function(response) {
							$("#log").html(response.image + "<br>" + JSON.stringify(response.attributes));
							mint(hash, "https://localhost/nfts/"+hash+".json");
						}
					});
				});		
		
		});
	<!-- end -->
	
	$("#init_nft").click(function() {
		f(); // initialise our wallet
	});
	
	

	
</script>